# spice_gen

Automatic SPICE netlist generator from YAML/JSON cell topology descriptions.

Define your circuit once in a readable YAML file — `spice_gen` handles port ordering, parameter formatting, and dialect-specific syntax for you.

## Features

- **YAML/JSON input** — describe cells with named, order-independent port connections
- **Correct port ordering** — MOSFET `D G S B`, BJT `C B E`, diode `A K`, etc. are enforced automatically
- **Primitive devices** — NMOS, PMOS, NPN, PNP, R, C, L, voltage/current sources, diode
- **Hierarchical subcircuits** — instantiate `.subckt` blocks; port order resolved from definition
- **Multiple output dialects** — `spice3`, `hspice`, `ngspice`
- **CLI tool** — single command, stdout or file output

## Installation

Requires Python 3.10+.

```bash
pip install -e .
```

To include development dependencies (pytest):

```bash
pip install -e ".[dev]"
```

## Quick Start

```bash
# SPICE3 (default)
spice_gen examples/inverter.yaml --stdout

# HSPICE to file
spice_gen examples/nand2.yaml --dialect hspice --output nand2.sp

# ngspice to stdout
spice_gen examples/opamp_snippet.yaml --dialect ngspice --stdout
```

## Input Format

Topology files use a simple YAML (or JSON) schema:

```yaml
cell:
  name: INV
  ports: [A, Z, VDD, VSS]   # defines .subckt pin order
  components:
    - id: MP1
      type: primitive
      model: pmos            # nmos | pmos | npn | pnp | r | c | l | vsrc | isrc | diode
      connections:           # named dict — order does not matter
        D: Z
        G: A
        S: VDD
        B: VDD
      parameters:
        W: 2e-6
        L: 180e-9
        model_name: pch      # device model card reference

    - id: MN1
      type: primitive
      model: nmos
      connections: {D: Z, G: A, S: VSS, B: VSS}
      parameters: {W: 1e-6, L: 180e-9, model_name: nch}
```

Subcircuit instantiation:

```yaml
    - id: XBIAS
      type: subckt
      model: BIAS_GEN        # referenced .subckt name
      connections:
        VREF: vref_node
        VDD: VDD
        VSS: VSS
        IOUT: tail_net
```

### Supported primitive models

| `model` | SPICE letter | Port order |
|---------|-------------|------------|
| `nmos`, `pmos` | `M` | `D G S B` |
| `npn`, `pnp` | `Q` | `C B E` |
| `r` | `R` | `P N` + `value` |
| `c` | `C` | `P N` + `value` |
| `l` | `L` | `P N` + `value` |
| `vsrc` | `V` | `P N` + `value` |
| `isrc` | `I` | `P N` + `value` |
| `diode` | `D` | `A K` |

## Output Examples

**Inverter — SPICE3**

```spice
* Generated by spice_gen  [spice3]  cell=INV
.subckt INV A Z VDD VSS
MMP1 Z A VDD VDD pch W=2e-6 L=180e-9
MMN1 Z A VSS VSS nch W=1e-6 L=180e-9
.ends INV
```

**NAND2 — HSPICE**

```spice
* Generated by spice_gen  [hspice]  cell=NAND2
.subckt NAND2 A B Z VDD VSS
MMP1 Z A VDD VDD pch PARAMS: W=2e-6 L=180e-9
MMP2 Z B VDD VDD pch PARAMS: W=2e-6 L=180e-9
MMN1 Z A mid VSS nch PARAMS: W=2e-6 L=180e-9
MMN2 mid B VSS VSS nch PARAMS: W=2e-6 L=180e-9
.ends NAND2
```

**Diff pair — ngspice**

```spice
* Generated by spice_gen  [ngspice]  cell=DIFF_PAIR
.param IBIAS=10e-6
.subckt DIFF_PAIR INP INN TAIL VDD OUT_P OUT_N params: IBIAS=10e-6
MM1 OUT_N INP TAIL VSS nch_hv W=10e-6 L=500e-9
MM2 OUT_P INN TAIL VSS nch_hv W=10e-6 L=500e-9
IITAIL TAIL VSS {IBIAS}
RR_LOAD1 VDD OUT_N 10000
RR_LOAD2 VDD OUT_P 10000
CC_COMP OUT_P OUT_N 1e-12
XXBIAS vref_node VDD VSS TAIL BIAS_GEN
.ends DIFF_PAIR
```

## CLI Reference

```
spice_gen <input> [-d DIALECT] [-o FILE] [--stdout] [-v]

positional arguments:
  input              Path to input .yaml, .yml, or .json file

options:
  -d, --dialect      Output dialect: spice3 | hspice | ngspice  (default: spice3)
  -o, --output       Output file path (default: <input_stem>_<dialect>.sp)
  --stdout           Write to stdout instead of a file
  -v, --verbose      Print diagnostic info to stderr
```

## Project Structure

```
src/spice_gen/
├── model/
│   ├── primitives.py    # port-order registry — single source of truth
│   ├── component.py     # PrimitiveComponent, SubcktInstance
│   └── netlist.py       # SubcktDef, Netlist
├── schema/
│   └── cell_schema.py   # Pydantic v2 input validation
├── parser/
│   ├── loader.py        # YAML/JSON → Netlist
│   └── builder.py       # validated schema → internal model
├── generator/
│   ├── base.py          # abstract SpiceGenerator
│   ├── spice3.py
│   ├── hspice.py
│   └── ngspice.py
└── cli.py
```

## Running Tests

```bash
pytest tests/ -v
```

39 tests covering unit (primitives, builder, generators) and integration (full YAML-to-SPICE round-trips for all three dialects).

## Extending with a New Dialect

Subclass `SpiceGenerator` and implement two methods:

```python
from spice_gen.generator.base import SpiceGenerator

class LtspiceGenerator(SpiceGenerator):
    DIALECT_NAME = "ltspice"

    def _format_subckt_params(self, params):
        return ""  # LTspice uses .param separately

    def _format_instance_params(self, params):
        return " ".join(f"{k}={v}" for k, v in params.items())
```

Then register it in `generator/__init__.py`:

```python
DIALECT_REGISTRY["ltspice"] = LtspiceGenerator
```
